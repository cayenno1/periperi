// Firestore Security Rules - SIMPLIFIED FOR TESTING
// Use this to test if updates work, then we can add restrictions back
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isValidRole(role) {
      return role in ['Staff', 'Admin', 'Manager', 'Owner', 'System_Admin'];
    }
    
    function isValidStatus(status) {
      return status in ['active', 'suspended', 'inactive', 'deleted'];
    }

    function isValidUnitType(unitType) {
      return unitType in ['weight', 'count'];
    }

    function isValidBaseUnit(unitType, baseUnit) {
      return (unitType == 'count' && baseUnit == 'pcs') ||
             (unitType == 'weight' && baseUnit in ['g', 'kg']);
    }

    function isNonNegativeNumber(value) {
      return value is number && value >= 0;
    }

    function hasValidTimestamps(data) {
      return (!('createdAt' in data) || data.createdAt is timestamp) &&
             (!('updatedAt' in data) || data.updatedAt is timestamp);
    }

    function isValidStockDocument(data) {
      return data.keys().hasAll(['name', 'unitType', 'baseUnit', 'quantity', 'reorderLevel']) &&
             data.name is string && data.name.size() > 0 &&
             isValidUnitType(data.unitType) &&
             isValidBaseUnit(data.unitType, data.baseUnit) &&
             isNonNegativeNumber(data.quantity) &&
             isNonNegativeNumber(data.reorderLevel) &&
             hasValidTimestamps(data);
    }

    function isValidStockUpdate(newData, existingData) {
      return isValidStockDocument(newData) &&
             newData.name == existingData.name &&
             newData.unitType == existingData.unitType &&
             newData.baseUnit == existingData.baseUnit &&
             newData.quantity >= 0;
    }

// CUSTOMERS COLLECTION
    match /customers/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

// STAFF COLLECTION
    match /staff/{staffId} {
      allow create: if true;
      allow read: if true;

      // SIMPLIFIED UPDATE RULE - Allows updates with basic validation
      // Remove hasOnly() check temporarily to test
      allow update: if (
        // Prevent changing staffId (immutable)
        request.resource.data.staffId == resource.data.staffId &&
        
        // Prevent changing password directly
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['password']) ||
         request.resource.data.password == resource.data.password) &&
        
        // Basic field validation
        request.resource.data.firstName is string && 
        request.resource.data.firstName.size() > 0 &&
        request.resource.data.lastName is string && 
        request.resource.data.lastName.size() > 0 &&
        request.resource.data.email is string && 
        request.resource.data.email.matches('.*@.*\\..*') &&
        request.resource.data.role is string && 
        isValidRole(request.resource.data.role) &&
        request.resource.data.status is string && 
        isValidStatus(request.resource.data.status)
      );

      allow delete: if false;
    }

// STOCKS COLLECTION (Inventory)
    match /stocks/{stockId} {
      allow read: if true;
      allow create: if isValidStockDocument(request.resource.data);
      allow update: if isValidStockUpdate(request.resource.data, resource.data);
      allow delete: if false;
    }
  }
}


